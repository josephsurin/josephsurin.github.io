{
    "componentChunkName": "component---src-templates-md-blog-post-js",
    "path": "/posts/2021-12-12-x-mas-ctf-2021-worst-two-reindeer-writeup",
    "result": {"data":{"markdownRemark":{"html":"<h1>Worst two reindeer</h1>\n<blockquote>\n<p>This year, Santa decided to pair up two of his worst reindeer to pull his sleigh, hoping that two wrongs can make a right.</p>\n<p>He chose Randolf and Xixen to do this deed. They first had to come up with some cryptography challenge that should prove their superior intellect.</p>\n<p>They came up with some block cipher and asked you to proof check their work. Do your worst and show them who's the boss.</p>\n<p><code>nc challs.xmas.htsp.ro 1035</code></p>\n</blockquote>\n<p><code>challenge.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> utils <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> constants <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">round_function</span><span class=\"token punctuation\">(</span>inp<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    i1 <span class=\"token operator\">=</span> inp<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>HALF_WORD_SIZE<span class=\"token punctuation\">]</span>\n    i0 <span class=\"token operator\">=</span> inp<span class=\"token punctuation\">[</span>HALF_WORD_SIZE<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    k1 <span class=\"token operator\">=</span> key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>HALF_WORD_SIZE<span class=\"token punctuation\">]</span>\n    k0 <span class=\"token operator\">=</span> key<span class=\"token punctuation\">[</span>HALF_WORD_SIZE<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n    x <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> k1<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> k1<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n\n    o1 <span class=\"token operator\">=</span> rotate_right<span class=\"token punctuation\">(</span>xor<span class=\"token punctuation\">(</span>i0<span class=\"token punctuation\">,</span> k0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span>\n    o0 <span class=\"token operator\">=</span> xor<span class=\"token punctuation\">(</span>rotate_left<span class=\"token punctuation\">(</span>i1<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> k1<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> o1 <span class=\"token operator\">+</span> o0\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">cipher</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">assert</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> KEY_SIZE <span class=\"token operator\">//</span> <span class=\"token number\">8</span>\n        self<span class=\"token punctuation\">.</span>key <span class=\"token operator\">=</span> bytes_2_bit_array<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>round_keys <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_get_key_schedule<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">_get_key_schedule</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        key_copy <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>key\n        keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>ROUNDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            k3 <span class=\"token operator\">=</span> key_copy<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span> HALF_WORD_SIZE<span class=\"token punctuation\">]</span>\n            k1 <span class=\"token operator\">=</span> key_copy<span class=\"token punctuation\">[</span>HALF_WORD_SIZE<span class=\"token punctuation\">:</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> HALF_WORD_SIZE<span class=\"token punctuation\">]</span>\n            k2 <span class=\"token operator\">=</span> key_copy<span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> HALF_WORD_SIZE<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token operator\">*</span> HALF_WORD_SIZE<span class=\"token punctuation\">]</span>\n            k0 <span class=\"token operator\">=</span> key_copy<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>HALF_WORD_SIZE<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n            keys<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>k1 <span class=\"token operator\">+</span> k0<span class=\"token punctuation\">)</span>\n\n            k0 <span class=\"token operator\">=</span> xor<span class=\"token punctuation\">(</span>rotate_left<span class=\"token punctuation\">(</span>k0<span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> k1<span class=\"token punctuation\">)</span>\n            k2 <span class=\"token operator\">=</span> rotate_right<span class=\"token punctuation\">(</span>xor<span class=\"token punctuation\">(</span>k2<span class=\"token punctuation\">,</span> k3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n            k3 <span class=\"token operator\">=</span> rotate_left<span class=\"token punctuation\">(</span>xor<span class=\"token punctuation\">(</span>k3<span class=\"token punctuation\">,</span> k1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n            k1 <span class=\"token operator\">=</span> xor<span class=\"token punctuation\">(</span>rotate_right<span class=\"token punctuation\">(</span>k1<span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> k2<span class=\"token punctuation\">)</span>\n\n            key_copy <span class=\"token operator\">=</span> k3 <span class=\"token operator\">+</span> k2 <span class=\"token operator\">+</span> k1 <span class=\"token operator\">+</span> k0\n\n        <span class=\"token keyword\">return</span> keys\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> plaintext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        pt <span class=\"token operator\">=</span> bytes_2_bit_array<span class=\"token punctuation\">(</span>plaintext<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">assert</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>pt<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLOCK_SIZE\n\n        pt1 <span class=\"token operator\">=</span> pt<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>WORD_SIZE<span class=\"token punctuation\">]</span>\n        pt0 <span class=\"token operator\">=</span> pt<span class=\"token punctuation\">[</span>WORD_SIZE<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>ROUNDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            pt1<span class=\"token punctuation\">,</span> pt0 <span class=\"token operator\">=</span> pt0<span class=\"token punctuation\">,</span> xor<span class=\"token punctuation\">(</span>pt1<span class=\"token punctuation\">,</span> round_function<span class=\"token punctuation\">(</span>pt0<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>round_keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> bit_array_2_bytes<span class=\"token punctuation\">(</span>pt1 <span class=\"token operator\">+</span> pt0<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> ciphertext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        ct <span class=\"token operator\">=</span> bytes_2_bit_array<span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">assert</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>ct<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> BLOCK_SIZE\n\n        ct0 <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>WORD_SIZE<span class=\"token punctuation\">]</span>\n        ct1 <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">[</span>WORD_SIZE<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>ROUNDS <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            ct1<span class=\"token punctuation\">,</span> ct0 <span class=\"token operator\">=</span> ct0<span class=\"token punctuation\">,</span> xor<span class=\"token punctuation\">(</span>ct1<span class=\"token punctuation\">,</span> round_function<span class=\"token punctuation\">(</span>ct0<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>round_keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> bit_array_2_bytes<span class=\"token punctuation\">(</span>ct0 <span class=\"token operator\">+</span> ct1<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code>constants.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\">POW_NIBBLES <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\nACTION_CNT <span class=\"token operator\">=</span> <span class=\"token number\">4</span>\n\nKEY_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\nBLOCK_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\nWORD_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">32</span>\nHALF_WORD_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">16</span>\nROUNDS <span class=\"token operator\">=</span> <span class=\"token number\">8</span>\nFLAG <span class=\"token operator\">=</span> <span class=\"token string\">'[REDACTED]'</span></code></pre></div>\n<p><code>utils.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">def</span> <span class=\"token function\">bytes_2_bit_array</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> b <span class=\"token keyword\">in</span> x<span class=\"token punctuation\">:</span>\n        result <span class=\"token operator\">+=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> a <span class=\"token keyword\">in</span> <span class=\"token builtin\">bin</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>zfill<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> result\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">bit_array_2_bytes</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    result <span class=\"token operator\">=</span> <span class=\"token string\">b''</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        result <span class=\"token operator\">+=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">+</span> <span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> a <span class=\"token keyword\">in</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">:</span> i <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> byteorder<span class=\"token operator\">=</span><span class=\"token string\">'big'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">xor</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>x <span class=\"token operator\">^</span> y <span class=\"token keyword\">for</span> x<span class=\"token punctuation\">,</span> y <span class=\"token keyword\">in</span> <span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">,</span> shift<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> arr<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>shift<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> arr<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span>shift<span class=\"token punctuation\">]</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">,</span> shift<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> arr<span class=\"token punctuation\">[</span>shift<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> arr<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>shift<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Challenge Overview</h2>\n<p>After connecting and solving the pow, we are presented with a challenge:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Randolf: Hey, so... Santa gave us a challenge and we did our best but we need help from someone experienced with cryptography to check our work!\nXixen: We need to see if you can encrypt any plaintext if we only give you one plaintext-ciphertext pair\nRandolf: If you do so, hopefully you won't though :), we will reward you with one present from Santa's personal Christmas tree\nXixen: Now get to work! You'll also have to prove that the exploit is consistent so you will have to do it 4 times. Good luck!\n\nStep #1 of 4\nplaintext = b'9ec55499ff13d2ee'\nciphertext = b'e6e761cdcb9504c0'\n\nPlease encrypt this plaintext for us:\n\nplaintext = b'c642dc17d7b9d78c'\n\nGive me an integer in hexadecimal format\nciphertext =</code></pre></div>\n<p>To get the flag, we need to solve 4 identical challenges each of which consists of encrypting an arbitrary plaintext, given just one plaintext-ciphertext pair for the challenge's custom block cipher.</p>\n<p>It's reasonable to assume that the goal is key recovery. And given that we only have one plaintext-ciphertext pair, we thought that the cipher would be completely linear, in which case the key could be recovered by forming a system of linear equations involving the plaintext, key, and ciphertext, then solve for the key bits.</p>\n<h2>The Block Cipher</h2>\n<p>The block cipher in the challenge operates on 8-byte blocks. It's a Feistel cipher with mostly constant shift rotate and XOR operations. The key schedule consists entirely of constant shift rotations and XORs, so we can safely assume that each round key can be expressed as a linear function of the cipher key. The round function is the part we need to study the most. It consists of a variable shift rotation which depends on some bits of the round key. This adds some nonlinearity to the cipher which will be annoying to deal with if our plan is to try and express the entire encryption process as a system of linear equations. Fortunately, it turns out to be not that big of an obstacle; since there are 8 rounds, and the possible values of the variable shift amount is between <code>0</code> and <code>3</code> (inclusive), then the total number of possibilities for the variable shift amounts is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>4</mn><mn>8</mn></msup><mo>=</mo><msup><mn>2</mn><mn>16</mn></msup></mrow><annotation encoding=\"application/x-tex\">4^8 = 2^{16}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">4</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">8</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">16</span></span></span></span></span></span></span></span></span></span></span></span></span>. This is a fairly reasonable amount to bruteforce; the idea will be to exhaust over the possible shift amounts, then treat the system as if it were a completely linear system.</p>\n<h2>Crafting the System of Equations</h2>\n<p>We've already been given the block cipher implementation, so we can take it easy and let Sage do most of the work. This is a useful technique to know; we can evaluate the encryption of a plaintext with some symbolic key variables, which in this case, are variables of a polynomial ring over <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">F</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{F}_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83889em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">F</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span>. We'll write everything as vectors with entries in <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">F</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{F}_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83889em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">F</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span>, so XOR will be replaced with addition.</p>\n<p>Assume we know (since we're bruteforcing it) the variable shift amounts used in the round function. When we run through the encryption process with the symbolic key variables, if we inspect the result of the encryption, we'll notice that each entry in the resulting ciphertext vector is a linear combination of the key bits. With an equality between each entry of this result, and each ciphertext bit, we have a linear system of 64 equations in 64 variables! We can solve for the key unknowns by adding the ciphertext to the encryption result, taking the coefficient matrix of the linear equations, and then looking through the (right) kernel of this matrix.</p>\n<p>But! Most of the time, the kernel will have some vectors in it which work as a valid key, <em>with</em> the assumed shift amounts. To reduce the number of false positives, we filter through the elements of the kernel by only taking the keys that match the assumed shift amounts. That is, the keys that would yield the same variable shift amounts as what we assumed (if we were to run the key schedule and pick the relevant bits for each round key). In hindsight, it may have been more efficient to bruteforce the two relevant bits in each round key instead of going the other way and bruteforcing the shifts themselves. But, I think this way is easier to think about and implement.</p>\n<h2>Efficiency and Reliability</h2>\n<p>The implementation isn't very efficient; it takes around 20 minutes to exhaust over the <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mn>16</mn></msup></mrow><annotation encoding=\"application/x-tex\">2^{16}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">16</span></span></span></span></span></span></span></span></span></span></span></span></span> shift amounts and recover the key. From purely empirical observations, it seems like there are two keys valid keys (which satisfy the given plaintext-ciphertext pair, as well as matching the assume shift variables). Since we have no way of telling which is the actual key, we have a 1/2 probability of getting it right. The challenge originally required us to solve 4 in a row (but was later changed to 2). We managed to solve the original version by leaving it running overnight and hoping for the best.</p>\n<h2>Implementation</h2>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">import</span> os\nos<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">[</span><span class=\"token string\">'PWNLIB_NOTERM'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'True'</span>\n<span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> hashlib <span class=\"token keyword\">import</span> sha256\n<span class=\"token keyword\">import</span> itertools\n<span class=\"token keyword\">from</span> tqdm <span class=\"token keyword\">import</span> tqdm\n\nWORD_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">32</span>\nROUNDS <span class=\"token operator\">=</span> <span class=\"token number\">8</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">bytes_to_vec</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> b <span class=\"token keyword\">in</span> x<span class=\"token punctuation\">:</span>\n        result <span class=\"token operator\">+=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> a <span class=\"token keyword\">in</span> <span class=\"token builtin\">bin</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>zfill<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">bit_array_2_bytes</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token builtin\">map</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> byteorder<span class=\"token operator\">=</span><span class=\"token string\">'big'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">rotate_right</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">,</span> shift<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>shift<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span>shift<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">rotate_left</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">,</span> shift<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">[</span>shift<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>shift<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_key_schedule</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    key_copy <span class=\"token operator\">=</span> key\n    keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>ROUNDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        k3 <span class=\"token operator\">=</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> key_copy<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span> WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        k1 <span class=\"token operator\">=</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> key_copy<span class=\"token punctuation\">[</span>WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        k2 <span class=\"token operator\">=</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> key_copy<span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span> <span class=\"token operator\">*</span> WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        k0 <span class=\"token operator\">=</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> key_copy<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        keys<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>k1<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>k0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        k0 <span class=\"token operator\">=</span> rotate_left<span class=\"token punctuation\">(</span>k0<span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> k1\n        k2 <span class=\"token operator\">=</span> rotate_right<span class=\"token punctuation\">(</span>k2 <span class=\"token operator\">+</span> k3<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n        k3 <span class=\"token operator\">=</span> rotate_left<span class=\"token punctuation\">(</span>k3 <span class=\"token operator\">+</span> k1<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n        k1 <span class=\"token operator\">=</span> rotate_right<span class=\"token punctuation\">(</span>k1<span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> k2\n\n        key_copy <span class=\"token operator\">=</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>k3<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>k2<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>k1<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>k0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> keys\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">round_function</span><span class=\"token punctuation\">(</span>inp<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    i1 <span class=\"token operator\">=</span> inp<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n    i0 <span class=\"token operator\">=</span> inp<span class=\"token punctuation\">[</span>WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    k1 <span class=\"token operator\">=</span> key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n    k0 <span class=\"token operator\">=</span> key<span class=\"token punctuation\">[</span>WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n    o1 <span class=\"token operator\">=</span> rotate_right<span class=\"token punctuation\">(</span>i0 <span class=\"token operator\">+</span> k0<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span>\n    o0 <span class=\"token operator\">=</span> rotate_left<span class=\"token punctuation\">(</span>i1<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> k1\n\n    <span class=\"token keyword\">return</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>o1<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>o0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span>pt<span class=\"token punctuation\">,</span> round_keys<span class=\"token punctuation\">,</span> Xs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    pt1 <span class=\"token operator\">=</span> pt<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>WORD_SIZE<span class=\"token punctuation\">]</span>\n    pt0 <span class=\"token operator\">=</span> pt<span class=\"token punctuation\">[</span>WORD_SIZE<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>ROUNDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        pt1<span class=\"token punctuation\">,</span> pt0 <span class=\"token operator\">=</span> pt0<span class=\"token punctuation\">,</span> pt1 <span class=\"token operator\">+</span> round_function<span class=\"token punctuation\">(</span>pt0<span class=\"token punctuation\">,</span> round_keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> Xs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> vector<span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>pt1<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>pt0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">eqns_to_matrix</span><span class=\"token punctuation\">(</span>eqns<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    M <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> eq <span class=\"token keyword\">in</span> eqns<span class=\"token punctuation\">:</span>\n        r <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token number\">65</span>\n        <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> eq<span class=\"token punctuation\">:</span>\n            r<span class=\"token punctuation\">[</span>K_<span class=\"token punctuation\">[</span>c<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        M<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> Matrix<span class=\"token punctuation\">(</span>GF<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> M<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">check_Xs</span><span class=\"token punctuation\">(</span>round_keys<span class=\"token punctuation\">,</span> Xs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>ROUNDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        key <span class=\"token operator\">=</span> round_keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n        k1 <span class=\"token operator\">=</span> key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>WORD_SIZE<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n        x <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>k1<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>k1<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> x <span class=\"token operator\">!=</span> Xs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">recover_key</span><span class=\"token punctuation\">(</span>pt<span class=\"token punctuation\">,</span> ct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    round_keys <span class=\"token operator\">=</span> get_key_schedule<span class=\"token punctuation\">(</span>K<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> Xs <span class=\"token keyword\">in</span> tqdm<span class=\"token punctuation\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>itertools<span class=\"token punctuation\">.</span>product<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> repeat<span class=\"token operator\">=</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        enc_pt <span class=\"token operator\">=</span> encrypt<span class=\"token punctuation\">(</span>pt<span class=\"token punctuation\">,</span> round_keys<span class=\"token punctuation\">,</span> Xs<span class=\"token punctuation\">)</span>\n        M <span class=\"token operator\">=</span> eqns_to_matrix<span class=\"token punctuation\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>enc_pt <span class=\"token operator\">+</span> ct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># check if the Xs match with the recovered key values</span>\n        <span class=\"token keyword\">for</span> key <span class=\"token keyword\">in</span> M<span class=\"token punctuation\">.</span>right_kernel<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> key<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> GF<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">continue</span>\n            key <span class=\"token operator\">=</span> key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n            rks <span class=\"token operator\">=</span> get_key_schedule<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> check_Xs<span class=\"token punctuation\">(</span>rks<span class=\"token punctuation\">,</span> Xs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'found key!'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> Xs<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>rks<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">.</span>right_nullity<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">return</span> rks<span class=\"token punctuation\">,</span> Xs\n\nP <span class=\"token operator\">=</span> BooleanPolynomialRing<span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string-interpolation\"><span class=\"token string\">f'k_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>i<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nK <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">.</span>gens<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nK_ <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> k<span class=\"token punctuation\">:</span> i <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span>k <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>K<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\nK_<span class=\"token punctuation\">[</span>P<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">solve_pow</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        hashresult <span class=\"token operator\">=</span> hashlib<span class=\"token punctuation\">.</span>sha256<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hexdigest<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> hashresult<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> target\n    ans <span class=\"token operator\">=</span> util<span class=\"token punctuation\">.</span>iters<span class=\"token punctuation\">.</span>mbruteforce<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> string<span class=\"token punctuation\">.</span>digits <span class=\"token operator\">+</span> string<span class=\"token punctuation\">.</span>ascii_letters<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'upto'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> ans<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">solve_step</span><span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    conn<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'plaintext ='</span><span class=\"token punctuation\">)</span>\n    pt <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" b'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">\"'\\n\"</span><span class=\"token punctuation\">)</span>\n    ct <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" b'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">\"'\\n\"</span><span class=\"token punctuation\">)</span>\n    conn<span class=\"token punctuation\">.</span>recvuntil<span class=\"token punctuation\">(</span><span class=\"token string\">b'plaintext ='</span><span class=\"token punctuation\">)</span>\n    target <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">\" b'\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">\"'\\n\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>pt<span class=\"token punctuation\">,</span> ct<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span>\n    pt <span class=\"token operator\">=</span> bytes_to_vec<span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">.</span>fromhex<span class=\"token punctuation\">(</span>pt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    ct <span class=\"token operator\">=</span> bytes_to_vec<span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">.</span>fromhex<span class=\"token punctuation\">(</span>ct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    target <span class=\"token operator\">=</span> bytes_to_vec<span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">.</span>fromhex<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'attempting to recover key...'</span><span class=\"token punctuation\">)</span>\n    rks<span class=\"token punctuation\">,</span> Xs <span class=\"token operator\">=</span> recover_key<span class=\"token punctuation\">(</span>pt<span class=\"token punctuation\">,</span> ct<span class=\"token punctuation\">)</span>\n    c <span class=\"token operator\">=</span> encrypt<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> rks<span class=\"token punctuation\">,</span> Xs<span class=\"token punctuation\">)</span>\n    c <span class=\"token operator\">=</span> bit_array_2_bytes<span class=\"token punctuation\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    conn<span class=\"token punctuation\">.</span>sendlineafter<span class=\"token punctuation\">(</span><span class=\"token string\">'ciphertext = '</span><span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">attempt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    conn <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">'challs.xmas.htsp.ro'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1035</span><span class=\"token punctuation\">)</span>\n    target <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    ans <span class=\"token operator\">=</span> solve_pow<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n    conn<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>ans<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        solve_step<span class=\"token punctuation\">(</span>conn<span class=\"token punctuation\">)</span>\n        res <span class=\"token operator\">=</span> conn<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token string\">'Good'</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> res<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n\n    conn<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span>\n\ncontext<span class=\"token punctuation\">.</span>log_level <span class=\"token operator\">=</span> <span class=\"token string\">'debug'</span>\n<span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> attempt<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">break</span></code></pre></div>\n<p><code>X-MAS{RX_Cryp706r4phy_1s_N0t_S3cur3_W3_N33d_M0re_P0w3r!!!_9uh2f0uh}</code></p>","frontmatter":{"date":"December 12, 2021","path":"/posts/2021-12-12-x-mas-ctf-2021-worst-two-reindeer-writeup","title":"X-MAS CTF 2021 - Worst two reindeer","tags":"ctf,writeup,crypto"}}},"pageContext":{"prev":{"fileAbsolutePath":"/media/winarch-shared/code/portfolio/src/posts/2021-10-03-tsg-ctf-2021-crypto-writeups/index.md","frontmatter":{"title":"TSG CTF 2021 - Crypto","date":"2021-10-03T00:00:00.000Z","path":"/posts/2021-10-03-tsg-ctf-2021-crypto-writeups"}},"next":null}},
    "staticQueryHashes": ["4146750380"]}